name: Deploy SimpleBlogCMS to GitHub Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP for documentation
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, dom, xml

      - name: Install phpDocumentor
        run: |
          composer require --dev phpdocumentor/phpdocumentor --no-interaction --no-progress

      - name: Generate API documentation
        run: |
          ./vendor/bin/phpdoc \
            -d ./class \
            -d ./admin \
            -t ./_site \
            --template="clean" \
            --title="SimpleBlogCMS API Documentation" \
            --defaultpackagename="SimpleBlogCMS"

      - name: Create comprehensive overview page
        run: |
          cat > _site/overview.html << 'EOF'
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimpleBlogCMS - System Overview</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 2rem;
            background: #f8f9fa;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 1rem;
            margin-bottom: 2rem;
        }
        h2 {
            color: #34495e;
            margin-top: 2rem;
            border-left: 4px solid #3498db;
            padding-left: 1rem;
        }
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        .feature-card {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            margin: 10px 5px;
            font-weight: 500;
        }
        .btn-outline {
            background: transparent;
            border: 2px solid #3498db;
            color: #3498db;
        }
        .nav-header {
            background: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            margin: -2rem -2rem 2rem -2rem;
            border-radius: 10px 10px 0 0;
        }
        .class-list {
            columns: 2;
            gap: 1rem;
            margin: 1rem 0;
        }
        .class-list a {
            display: block;
            padding: 0.5rem;
            color: #2c3e50;
            text-decoration: none;
            border-radius: 4px;
        }
        .class-list a:hover {
            background: #e3f2fd;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-header">
            <h1>SimpleBlogCMS - System Overview</h1>
            <p>Version 0.9.7 - Production Ready</p>
        </div>

        <div style="text-align: center; margin: 2rem 0;">
            <a href="navigation.html" class="btn">üß≠ Navigation</a>
            <a href="classes.html" class="btn">‚öôÔ∏è All Classes</a>
            <a href="https://github.com/pumba250/simpleBlogCMS" class="btn btn-outline" target="_blank">üêô GitHub</a>
        </div>

        <h2>üöÄ System Architecture</h2>
        <p>SimpleBlogCMS is a full-featured content management system designed for blogs and news websites with emphasis on security, performance, and ease of use.</p>

        <div class="feature-grid">
            <div class="feature-card">
                <h3>üìù Core Components</h3>
                <ul>
                    <li>News/Articles management with tags</li>
                    <li>Comments system with moderation</li>
                    <li>User authentication and roles</li>
                    <li>Template engine with themes</li>
                    <li>Caching system (files/Redis/Memcached)</li>
                </ul>
            </div>

            <div class="feature-card">
                <h3>üõ°Ô∏è Security Features</h3>
                <ul>
                    <li>CSRF, XSS, SQL injection protection</li>
                    <li>Email verification and CAPTCHA</li>
                    <li>Secure file upload validation</li>
                    <li>Rate limiting and brute-force protection</li>
                    <li>Content Security Policy (CSP)</li>
                </ul>
            </div>

            <div class="feature-card">
                <h3>üåê Internationalization</h3>
                <ul>
                    <li>Multi-language support (Russian/English)</li>
                    <li>Automatic language detection</li>
                    <li>Localized templates and content</li>
                    <li>UTF-8 encoding support</li>
                </ul>
            </div>
        </div>

        <h2>üìä Key Statistics</h2>
        <div class="feature-grid">
            <div class="feature-card">
                <h3>üèóÔ∏è Code Structure</h3>
                <ul>
                    <li>17 core PHP classes</li>
                    <li>MVC architecture pattern</li>
                    <li>SOLID principles implementation</li>
                    <li>Dependency injection</li>
                    <li>PSR-12 coding standards</li>
                </ul>
            </div>

            <div class="feature-card">
                <h3>üîß Technical Stack</h3>
                <ul>
                    <li>PHP 7.4+ with PDO, GD, MBString</li>
                    <li>MySQL 5.7+ / MariaDB 10.2+</li>
                    <li>HTML5, CSS3, JavaScript</li>
                    <li>GitHub Actions for CI/CD</li>
                    <li>Automatic updates system</li>
                </ul>
            </div>
        </div>

        <h2>üìÅ Core Classes Overview</h2>
        <div class="class-list">
            <a href="classes/Core.html">Core - Main request handler</a>
            <a href="classes/News.html">News - Articles management</a>
            <a href="classes/User.html">User - Authentication system</a>
            <a href="classes/Comments.html">Comments - Comment system</a>
            <a href="classes/Template.html">Template - Templating engine</a>
            <a href="classes/Cache.html">Cache - Caching system</a>
            <a href="classes/ErrorHandler.html">ErrorHandler - Error management</a>
            <a href="classes/Mailer.html">Mailer - Email system</a>
            <a href="classes/Lang.html">Lang - Localization</a>
            <a href="classes/Vote.html">Vote - Voting system</a>
            <a href="classes/Contact.html">Contact - Contact forms</a>
            <a href="classes/ImageUploader.html">ImageUploader - File uploads</a>
            <a href="classes/Updater.html">Updater - Auto-updates</a>
            <a href="classes/Parse.html">Parse - Content parsing</a>
            <a href="classes/Pagination.html">Pagination - Pagination system</a>
        </div>

        <div style="text-align: center; margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #eee;">
            <p>Documentation powered by phpDocumentor | Generated on $(date +"%Y-%m-%d at %H:%M")</p>
            <p>Project licensed under MIT License</p>
        </div>
    </div>
</body>
</html>
EOF

      - name: Create navigation page
        run: |
          cat > _site/navigation.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>SimpleBlogCMS Navigation</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 2rem;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        h1 {
            text-align: center;
            margin-bottom: 2rem;
        }
        .nav-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        .nav-card {
            background: rgba(255, 255, 255, 0.15);
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s ease;
        }
        .nav-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.2);
        }
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background: white;
            color: #667eea;
            text-decoration: none;
            border-radius: 6px;
            margin-top: 1rem;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>SimpleBlogCMS Documentation Navigation</h1>
        
        <div class="nav-grid">
            <div class="nav-card">
                <h3>üìñ System Overview</h3>
                <p>Complete system documentation and architecture</p>
                <a href="overview.html" class="btn">View Overview</a>
            </div>
            
            <div class="nav-card">
                <h3>‚öôÔ∏è All Classes</h3>
                <p>Detailed documentation of all PHP classes</p>
                <a href="classes.html" class="btn">Browse Classes</a>
            </div>
            
            <div class="nav-card">
                <h3>üß≠ Class Navigation</h3>
                <p>Quick access to specific class categories</p>
                <a href="#core" class="btn">Core Classes</a>
            </div>
        </div>

        <div style="margin-top: 3rem;">
            <h2>üöÄ Core Classes</h2>
            <div style="columns: 2; gap: 1rem;">
                <a href="classes/Core.html" style="display: block; color: white; padding: 0.5rem;">Core</a>
                <a href="classes/News.html" style="display: block; color: white; padding: 0.5rem;">News</a>
                <a href="classes/User.html" style="display: block; color: white; padding: 0.5rem;">User</a>
                <a href="classes/Comments.html" style="display: block; color: white; padding: 0.5rem;">Comments</a>
                <a href="classes/Template.html" style="display: block; color: white; padding: 0.5rem;">Template</a>
                <a href="classes/Cache.html" style="display: block; color: white; padding: 0.5rem;">Cache</a>
            </div>
        </div>
    </div>
</body>
</html>
EOF

      - name: Create main index with redirect
        run: |
          cat > _site/index.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <title>SimpleBlogCMS Documentation</title>
    <meta http-equiv="refresh" content="0; url=overview.html">
    <script>
        window.location.href = 'overview.html';
    </script>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; text-align: center; }
        a { color: #007bff; text-decoration: none; }
    </style>
</head>
<body>
    <h1>SimpleBlogCMS Documentation</h1>
    <p>Redirecting to system overview...</p>
    <p>If you are not redirected, <a href="overview.html">click here</a></p>
</body>
</html>
EOF

      - name: Disable Jekyll processing
        run: echo "" > _site/.nojekyll

      - name: Verify generated files
        run: |
          echo "üìÅ Generated documentation files:"
          ls -la _site/
          echo "üìÑ HTML files:"
          find _site -name "*.html" | head -10

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
