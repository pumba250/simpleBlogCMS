name: Advanced Documentation

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  documentation:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Find and remove ALL problematic composer files
      run: |
        echo "Searching for all composer.json files..."
        find . -name "composer.json" -type f | while read file; do
          echo "Found: $file"
          if grep -q '"__root__"' "$file"; then
            echo "ðŸš« Removing problematic file: $file"
            rm "$file"
          else
            echo "âœ… File is OK: $file"
          fi
        done
        
        # Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð²ÑÐµ composer.lock Ñ„Ð°Ð¹Ð»Ñ‹
        find . -name "composer.lock" -type f -delete
        echo "Removed all composer.lock files"

    - name: Create clean valid composer.json
      run: |
        cat > composer.json << 'EOL'
{
    "name": "simpleblogcms/cms",
    "description": "Simple Blog Content Management System",
    "type": "project",
    "license": "MIT",
    "authors": [{"name": "SimpleBlogCMS Team", "email": "dev@simpleblogcms.com"}],
    "require": {
        "php": ">=7.4"
    },
    "require-dev": {
        "phpdocumentor/phpdocumentor": "^3.3"
    },
    "autoload": {
        "classmap": ["class/", "admin/"]
    }
}
EOL
        echo "Created clean composer.json"

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, dom, xml, simplexml, json
        tools: composer

    - name: Install ONLY phpdocumentor (Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°)
      run: |
        # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ phpdocumentor Ð±ÐµÐ· Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
        composer require --dev phpdocumentor/phpdocumentor --no-interaction --no-progress

    - name: Generate API documentation (Ð¾Ð±Ñ…Ð¾Ð´Ð½Ð¾Ð¹ Ð¼ÐµÑ‚Ð¾Ð´)
      run: |
        # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¿Ñ€ÑÐ¼Ð¾Ð¹ Ð²Ñ‹Ð·Ð¾Ð² phpDocumentor Ñ ÑÐ²Ð½Ñ‹Ð¼Ð¸ Ð¿ÑƒÑ‚ÑÐ¼Ð¸
        php ./vendor/phpdocumentor/phpdocumentor/bin/phpdoc \
          -d ./class \
          -d ./admin \
          -t ./docs-api \
          --template="clean" \
          --title="SimpleBlogCMS API Documentation" \
          --defaultpackagename="SimpleBlogCMS"

    - name: Verify documentation generation
      run: |
        if [ -d "docs-api" ]; then
          echo "âœ… Documentation generated successfully!"
          echo "ðŸ“ Generated files:"
          find docs-api -name "*.html" | head -5
        else
          echo "âŒ Documentation generation failed"
          exit 1
        fi

    - name: Create index page
      run: |
        cat > docs-api/index.html << 'EOL'
<!DOCTYPE html>
<html>
<head>
    <title>simpleBlogCMS Documentation</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { margin-bottom: 30px; }
        .btn { display: inline-block; padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 5px; margin: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>simpleBlogCMS Documentation</h1>
        <div class="section">
            <h2>API Documentation</h2>
            <a href="./index.html" class="btn">View PHP Documentation</a>
        </div>
        <div class="section">
            <h2>Version: 0.9.7</h2>
            <p>Status: Production Ready</p>
        </div>
    </div>
</body>
</html>
EOL

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs-api
        keep_files: true
