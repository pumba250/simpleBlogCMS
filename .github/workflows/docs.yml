name: Advanced Documentation

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  documentation:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Clean up any problematic composer files
      run: |
        # Remove any existing composer files that might cause issues
        if [ -f composer.json ] && grep -q '"__root__"' composer.json; then
            echo "Removing problematic composer.json"
            rm composer.json
        fi
        if [ -f composer.lock ]; then
            rm composer.lock
        fi

    - name: Create valid composer.json
      run: |
        cat > composer.json << 'EOL'
{
    "name": "simpleblogcms/cms",
    "description": "Simple Blog Content Management System",
    "type": "project",
    "license": "MIT",
    "authors": [{"name": "SimpleBlogCMS Team", "email": "dev@simpleblogcms.com"}],
    "require": {
        "php": ">=7.4",
        "ext-pdo": "*",
        "ext-gd": "*",
        "ext-mbstring": "*",
        "ext-zip": "*"
    },
    "require-dev": {
        "phpdocumentor/phpdocumentor": "^3.3",
        "squizlabs/php_codesniffer": "^3.7",
        "friendsofphp/php-cs-fixer": "^3.13"
    },
    "autoload": {
        "classmap": ["class/", "admin/"]
    }
}
EOL

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, dom, xml, simplexml, json
        tools: composer

    - name: Install dependencies
      run: |
        composer install --no-progress --no-interaction

    - name: Generate API documentation
      run: |
        ./vendor/bin/phpdoc -d ./class -d ./admin -d ./config -t ./docs-api --template="clean" --defaultpackagename="SimpleBlogCMS"

    - name: Create index page
      run: |
        cat > docs-api/index.html << 'EOL'
<!DOCTYPE html>
<html>
<head>
    <title>simpleBlogCMS Documentation</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { margin-bottom: 30px; }
        .btn { display: inline-block; padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 5px; margin: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>simpleBlogCMS Documentation</h1>
        <div class="section">
            <h2>API Documentation</h2>
            <a href="./index.html" class="btn">View PHP Documentation</a>
        </div>
        <div class="section">
            <h2>Version: 0.9.7</h2>
            <p>Status: Production Ready</p>
        </div>
    </div>
</body>
</html>
EOL

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs-api
        keep_files: true
